<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Chat Bot</title>

  <!-- Security: strict CSP for static hosting -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    connect-src https://backend.fesinstitute.com;
    script-src 'self' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self';
    object-src 'none';
    base-uri 'none';
    frame-ancestors 'none';
    form-action 'self'">

  <style>
    /* (kept inline; allowed by style-src 'unsafe-inline') */
    p { max-width:800px; margin:8px auto; padding:10px 16px; border-radius:8px; }
    p, p[data-user="true"] { background:#f4f4f4; margin-left:auto; margin-right:0; }
    p:nth-child(odd){ background:#fff; margin-right:auto!important; margin-left:0!important; }
    .wrap{ padding:16px; max-width:1200px; margin:0 auto; }
    img{ max-width:300px; max-height:300px; display:block; }
    h1{ text-align:center; margin:32px 0; font-size:52px; }
    h3{ margin:24px 0 16px; }
    ul{ padding-bottom:16px; padding-left:1.5em; }
    li{ padding:16px 0; }
    input.chat{ position:fixed; left:16px; right:88px; padding:0 24px; bottom:16px; border:none; background:#f4f4f4; border-radius:32px; font-size:24px; outline:none; height:64px; }
    button.send{ position:fixed; bottom:24px; right:24px; width:48px; height:48px; font-size:24px; background:#000; color:#fff; border:none; border-radius:50%; cursor:pointer; transition:background-color .2s; }
    button.send:hover{ background:#0f8e6c; }
    body::before{ content:""; position:fixed; bottom:0; left:0; right:0; background:#fff; padding:16px; border-top:1px solid #fff; }
    body{ display:flex; flex-direction:column; position:relative; padding:0 16px; margin:0 auto; font-size:24px; padding-bottom:120px; }
    .log{ display:flex; flex-direction:column; gap:8px; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    .status{ text-align:center; font-size:.85em; color:#444; }
    .bot { background:#fff; }
  </style>

  <!-- Safe libraries from a reputable CDN -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js" defer></script>
</head>
<body>
  <h1>AI Chat Bot</h1>
  <div class="wrap">
    <div id="log" class="log" role="log" aria-live="polite" aria-relevant="additions text">
      <p class="bot">Hello</p>
      <p class="bot">Hello, how can I help you today?</p>
    </div>

    <p id="status" class="status" aria-live="polite"></p>
  </div>

  <label class="sr-only" for="chatInput">Message</label>
  <input id="chatInput" class="chat" placeholder="Type your message…" autocomplete="off" />
  <button id="sendBtn" class="send" aria-label="Send message">↑</button>

  <script type="module">
    const API = "https://backend.fesinstitute.com/api/public/chat";   // allowed in CSP
    const UID = "HGjUogPAKrZegs2PZIxfuV0kwKD3";                       // note: not a secret
    const logEl = document.getElementById("log");
    const inputEl = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const statusEl = document.getElementById("status");

    const sanitize = (html) => DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });

    function appendUser(text){
      const p = document.createElement("p");
      p.dataset.user = "true";
      p.textContent = text;                 // escape user input
      logEl.appendChild(p);
      p.scrollIntoView({ behavior: "smooth", block: "end" });
    }

    function appendBot(html, imageUrl){
      const container = document.createElement("div");
      container.className = "bot";
      // allow simple formatting from server, but sanitize first
      container.innerHTML = sanitize(html);
      // harden any links
      container.querySelectorAll("a[href]").forEach(a=>{
        try {
          const u = new URL(a.getAttribute("href"), location.origin);
          if (u.origin !== location.origin) {
            a.target = "_blank";
            a.rel = "noopener noreferrer";
          }
        } catch { a.removeAttribute("href"); }
      });
      // safe image handling (https-only)
      if (imageUrl && /^https:\/\//i.test(imageUrl)) {
        const img = document.createElement("img");
        img.src = imageUrl;
        img.alt = "Generated";
        img.referrerPolicy = "no-referrer";
        container.appendChild(img);
      }
      logEl.appendChild(container);
      container.scrollIntoView({ behavior: "smooth", block: "end" });
    }

    function formatServerText(reply){
      // Convert simple markdown-like patterns to HTML BEFORE sanitization
      const html = reply
        .replace(/###\s+(.*)/g, "<h3>$1</h3>")
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/^\s*-\s+(.+)/gm, "<ul><li>$1</li></ul>")
        .replace(/^\s*\d+\.\s+(.+)/gm, "<ol><li>$1</li></ol>");
      return html;
    }

    let inFlight = false;
    async function send(){
      const message = inputEl.value.trim();
      if (!message || inFlight) return;

      appendUser(message);
      inputEl.value = "";
      inputEl.focus();

      inFlight = true;
      sendBtn.disabled = true;
      statusEl.textContent = "Thinking…";

      try {
        const res = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, uid: UID }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const { reply = "Sorry, no response.", imageUrl } = await res.json();

        const formatted = formatServerText(String(reply));
        appendBot(formatted, imageUrl);
        statusEl.textContent = "";
      } catch (e) {
        appendBot("<p>Bot: Something went wrong. Please try again.</p>");
        statusEl.textContent = "";
      } finally {
        inFlight = false;
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", send);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); send(); }
    });
  </script>
</body>
</html>
